# 回调接口

敲黑板！！ 支付宝回调是用 `post` 请求的，所以我们在定义回调接口的时候不要搞错，要不然会导致接收不了回调。

## 什么时候触发支付回调

* TRADE_SUCCESS 【支付成功】
* TRADE_CLOSED 【交易关闭】



## 记录回调内容

可以将回调的内容打印到日志，方便后续排查

## 本地调试回调

可利用一些 内网穿透的工具 如 `ngork`，生产临时的外网地址，然后支付回调地址就可以写临时的外网地址， 支付完成后，本地就能接收到支付回调啦。

# 验签

## 主要验证参数

* 验证签名 sign
* 验证 对外商户订单号 `out_trade_no` 是否是服务产生的
* 验证 total_amount
* 验证 seller_id, appid

以上任何一个验证失败，都是不合法的异步回调



# ## 如何验证签名

### 代码调试

支付宝提供了 `rsaCheckV1`  的方法， 验签需要 支付宝公钥 ! 记住是支付宝公钥！ 不是应用公钥！！！



### 工具验证签名

支付宝提供了工具，具体教程可以看下这里的文章 https://docs.open.alipay.com/291/106097/



## 验证通过后服务要做的事情

### 处理业务逻辑

以下几个点需要注意

* 加锁，防止多次回调导致服务异常
* 非主流程异常应该俘获并打印到日志，确保主流程能进行,业务能正常的进行状态流转
* 确保状态流转的正确性
  * 正常的流转
    * 待支付 -> 支付关闭
    * 待支付 -> 支付完成
  * 不正常的流程
    * 关闭 -> 支付完成
    * 支付完成 -> 关闭

### 响应请求

需要返回 `success` 的字符



# 回调日志排查

如果出现没有支付回调，这个时候可以访问  https://openmonitor.alipay.com/acceptance/cloudparse.htm，输入 应用id, 对外商户订单号等信息，便可查到该订单号的回调情况